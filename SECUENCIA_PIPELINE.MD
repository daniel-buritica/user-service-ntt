# üìã Secuencia del Pipeline CI/CD

## üîÑ Diagrama de Secuencia

```
test ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ (Paralelo)
static-analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
dynamic-analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ (needs: [test])
                              ‚îÇ
build-and-push ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ (needs: [test, static-analysis, dynamic-analysis])
                              ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                                             ‚îÇ
composition-analysis ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    update-gitops ‚îÄ‚îÄ‚îò (needs: [build-and-push])
```

---

## üìä Aclaraci√≥n Importante: SCA vs DAST

**‚ö†Ô∏è El job `dynamic-analysis` NO es DAST real, es SCA (an√°lisis de composici√≥n).**

- **SCA (Software Composition Analysis):** Analiza dependencias y vulnerabilidades en librer√≠as (Trivy escanea imagen Docker)
- **DAST (Dynamic Application Security Testing):** Analiza aplicaci√≥n corriendo en runtime (requiere deploy temporal - no lo tenemos)

**Nuestro `dynamic-analysis` usa Trivy, que es SCA, no DAST.**

---

## üîç Detalle de Jobs y Steps

### Job 1: `test` - Unit Tests & Coverage

**Dependencias:** Ninguna (paralelo con `static-analysis`)

#### Step 1.1: Checkout code
- **Para qu√© sirve:** Descargar c√≥digo del repositorio
- **Justificaci√≥n:** Primer step necesario en todos los jobs

#### Step 1.2: Set up JDK 21
- **Para qu√© sirve:** Configurar Java 21 y cache de Maven
- **Justificaci√≥n:** Necesario antes de ejecutar comandos Maven

#### Step 1.3: Run tests with coverage
- **Para qu√© sirve:** Ejecutar tests unitarios y generar reporte de cobertura
- **Justificaci√≥n:** Valida funcionalidad antes de construir im√°genes

#### Step 1.4: Validate coverage >= 80%
- **Para qu√© sirve:** Validar que cobertura sea >= 80% (gate cr√≠tico)
- **Justificaci√≥n:** Bloquea despliegue si cobertura es insuficiente

#### Step 1.5: Upload coverage reports
- **Para qu√© sirve:** Subir reportes como artifacts
- **Justificaci√≥n:** √ötil para an√°lisis posterior

---

### Job 2: `static-analysis` - Static Code Analysis (SAST)

**Dependencias:** Ninguna (paralelo con `test`)

#### Step 2.1: Checkout code
- **Para qu√© sirve:** Descargar c√≥digo del repositorio
- **Justificaci√≥n:** Primer step necesario

#### Step 2.2: Set up JDK 21
- **Para qu√© sirve:** Configurar Java 21 y cache de Maven
- **Justificaci√≥n:** Necesario para compilar c√≥digo

#### Step 2.3: Initialize CodeQL
- **Para qu√© sirve:** Inicializar CodeQL para an√°lisis de seguridad
- **Justificaci√≥n:** Debe inicializarse ANTES de compilar (CodeQL rastrea la compilaci√≥n)

#### Step 2.4: Build with Maven
- **Para qu√© sirve:** Compilar c√≥digo (sin tests) para CodeQL
- **Justificaci√≥n:** CodeQL necesita c√≥digo compilado para analizar

#### Step 2.5: Perform CodeQL Analysis
- **Para qu√© sirve:** Analizar c√≥digo con CodeQL (detecta vulnerabilidades)
- **Justificaci√≥n:** Gate de seguridad que bloquea despliegue si encuentra problemas

#### Step 2.6: Run SonarQube Scan
- **Para qu√© sirve:** Analizar calidad de c√≥digo con SonarQube (opcional)
- **Justificaci√≥n:** Complementa CodeQL con an√°lisis de calidad

#### Step 2.7: Upload analysis results
- **Para qu√© sirve:** Subir resultados como artifacts
- **Justificaci√≥n:** √ötil para an√°lisis posterior

---

### Job 3: `dynamic-analysis` - Container Security Scan (SCA)

**‚ö†Ô∏è Nota:** Aunque se llama "dynamic-analysis", en realidad es **SCA** (an√°lisis de composici√≥n), no DAST.

**Dependencias:** `needs: [test]` - Solo se ejecuta si tests pasan

#### Step 3.1: Checkout code
- **Para qu√© sirve:** Descargar c√≥digo del repositorio
- **Justificaci√≥n:** Necesario para construir aplicaci√≥n

#### Step 3.2: Set up JDK 21
- **Para qu√© sirve:** Configurar Java 21 y cache de Maven
- **Justificaci√≥n:** Necesario para compilar aplicaci√≥n

#### Step 3.3: Build application
- **Para qu√© sirve:** Compilar y empaquetar aplicaci√≥n (generar JAR)
- **Justificaci√≥n:** Necesario antes de construir imagen Docker

#### Step 3.4: Build Docker image
- **Para qu√© sirve:** Construir imagen Docker temporal (tag: `:test`) para an√°lisis
- **Justificaci√≥n:** Trivy necesita una imagen Docker para escanear

#### Step 3.5: Run Trivy vulnerability scanner
- **Para qu√© sirve:** Escanear imagen Docker en busca de vulnerabilidades (CVEs) en dependencias y sistema operativo
- **Justificaci√≥n:** Gate de seguridad que detecta vulnerabilidades en la imagen antes de publicarla

#### Step 3.6: Upload Trivy results to GitHub Security
- **Para qu√© sirve:** Subir resultados a GitHub Security
- **Justificaci√≥n:** Visualizaci√≥n en interfaz de GitHub

#### Step 3.7: Upload Trivy report
- **Para qu√© sirve:** Subir reporte como artifact
- **Justificaci√≥n:** √ötil para an√°lisis posterior

---

### Job 4: `build-and-push` - Build & Push Docker Image

**Dependencias:** `needs: [test, static-analysis, dynamic-analysis]` - Solo se ejecuta si todos los gates pasan

**Condici√≥n:** Solo en `push` a `main` (no en PRs)

#### Step 4.1: Checkout code
- **Para qu√© sirve:** Descargar c√≥digo del repositorio
- **Justificaci√≥n:** Necesario para construir aplicaci√≥n

#### Step 4.2: Set up JDK 21
- **Para qu√© sirve:** Configurar Java 21 y cache de Maven
- **Justificaci√≥n:** Necesario para compilar aplicaci√≥n

#### Step 4.3: Build application
- **Para qu√© sirve:** Compilar y empaquetar aplicaci√≥n (generar JAR)
- **Justificaci√≥n:** Necesario antes de construir imagen Docker final

#### Step 4.4: Set up Docker Buildx
- **Para qu√© sirve:** Configurar Docker Buildx para construcci√≥n avanzada
- **Justificaci√≥n:** Habilita cache y construcci√≥n optimizada

#### Step 4.5: Log in to Docker Hub
- **Para qu√© sirve:** Autenticarse en DockerHub para hacer push
- **Justificaci√≥n:** Necesario antes de publicar imagen

#### Step 4.6: Log in to Quay.io
- **Para qu√© sirve:** Autenticarse en Quay.io (alternativa a DockerHub)
- **Justificaci√≥n:** Necesario si se usa Quay.io en lugar de DockerHub

#### Step 4.7: Extract metadata
- **Para qu√© sirve:** Generar tags y labels para la imagen (ej: `main-<SHA>`, `latest`)
- **Justificaci√≥n:** Identifica la versi√≥n de la imagen

#### Step 4.8: Build and push Docker image
- **Para qu√© sirve:** Construir imagen Docker final y publicarla en el registry
- **Justificaci√≥n:** Produce el artefacto final que se desplegar√°

#### Step 4.9: Output image info
- **Para qu√© sirve:** Mostrar informaci√≥n de la imagen en logs
- **Justificaci√≥n:** √ötil para debugging y confirmaci√≥n

---

### Job 5: `composition-analysis` - Composition Analysis (SBOM)

**Dependencias:** `needs: [build-and-push]` - Solo se ejecuta si la imagen se public√≥

**Condici√≥n:** Solo en `push` a `main` (no en PRs)

#### Step 5.1: Checkout code
- **Para qu√© sirve:** Descargar c√≥digo del repositorio
- **Justificaci√≥n:** Step est√°ndar

#### Step 5.2: Log in to Docker Hub
- **Para qu√© sirve:** Autenticarse en DockerHub para descargar imagen
- **Justificaci√≥n:** Necesario para descargar imagen publicada

#### Step 5.3: Log in to Quay.io
- **Para qu√© sirve:** Autenticarse en Quay.io (alternativa)
- **Justificaci√≥n:** Necesario si se usa Quay.io

#### Step 5.4: Generate SBOM from Docker image
- **Para qu√© sirve:** Generar Software Bill of Materials completo de la imagen Docker publicada
- **Justificaci√≥n:**
    - Debe ejecutarse DESPU√âS de publicar imagen porque analiza la imagen real que se desplegar√°
    - Incluye dependencias de aplicaci√≥n, sistema operativo y runtime
    - M√°s completo que SCA sobre c√≥digo fuente

#### Step 5.5: Upload SBOM
- **Para qu√© sirve:** Subir SBOM como artifact
- **Justificaci√≥n:** √ötil para auditor√≠a y compliance

---

### Job 6: `update-gitops` - Update GitOps Manifests

**Dependencias:** `needs: [build-and-push]` - Solo se ejecuta si la imagen se public√≥

**Condici√≥n:** Solo en `push` a `main` (no en PRs)

#### Step 6.1: Checkout code
- **Para qu√© sirve:** Descargar c√≥digo con permisos de escritura
- **Justificaci√≥n:** Necesario para hacer commit y push

#### Step 6.2: Configure Git
- **Para qu√© sirve:** Configurar usuario y email de Git
- **Justificaci√≥n:** Necesario antes de hacer commit

#### Step 6.3: Extract commit SHA (short)
- **Para qu√© sirve:** Extraer primeros 7 caracteres del commit SHA
- **Justificaci√≥n:** Se usa como tag de la imagen en Helm

#### Step 6.4: Update values.yaml with new image tag
- **Para qu√© sirve:** Actualizar tag de imagen en `helm/myapp/values.yaml`
- **Justificaci√≥n:** ArgoCD lee este archivo para desplegar la nueva versi√≥n

#### Step 6.5: Commit and push changes
- **Para qu√© sirve:** Hacer commit y push del cambio en `values.yaml`
- **Justificaci√≥n:** ArgoCD detecta el cambio y despliega autom√°ticamente

#### Step 6.6: Create summary
- **Para qu√© sirve:** Crear resumen visual en GitHub Actions
- **Justificaci√≥n:** Confirmaci√≥n visual del proceso

---

## üîó Dependencias Cr√≠ticas

### Gate de Cobertura
```
test (cobertura < 80%) ‚Üí ‚ùå FALLA
  ‚Üì
dynamic-analysis ‚Üí ‚ùå NO SE EJECUTA
  ‚Üì
build-and-push ‚Üí ‚ùå NO SE EJECUTA
```

### Gate de SAST
```
static-analysis (vulnerabilidad) ‚Üí ‚ùå FALLA
  ‚Üì
build-and-push ‚Üí ‚ùå NO SE EJECUTA
```

### Gate de SCA (Trivy)
```
dynamic-analysis (vulnerabilidad cr√≠tica) ‚Üí ‚ùå FALLA
  ‚Üì
build-and-push ‚Üí ‚ùå NO SE EJECUTA
```

---

## üìù Resumen

**Secuencia l√≥gica:** Validaci√≥n ‚Üí Construcci√≥n ‚Üí An√°lisis ‚Üí Despliegue

**Gates de seguridad:** Tests, SAST, SCA (Trivy) - todos bloquean despliegue si fallan

**Optimizaci√≥n:** Tests y SAST en paralelo

**Limitaci√≥n:** Sin deploy temporal, no podemos hacer DAST real (an√°lisis din√°mico de aplicaci√≥n corriendo)